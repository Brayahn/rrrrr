{
 "allow_comments": 0,
 "allow_delete": 0,
 "allow_edit": 0,
 "allow_incomplete": 0,
 "allow_multiple": 0,
 "allow_print": 0,
 "anonymous": 0,
 "apply_document_permissions": 1,
 "banner_image": "",
 "button_label": "Save",
 "client_script": "frappe.web_form.after_load = () => {\r\n    console.log('loaded');\r\n\r\n    // Function to get fee structure ID from student applications\r\n    const getFeeStructureFromStudentApplications = (program) => {\r\n        return new Promise((resolve) => {\r\n            // Get current student from web form\r\n            const studentName = frappe.web_form.get_value('student_applicant_name') || \r\n                               frappe.web_form.get_value('student');\r\n            \r\n            if (!studentName) {\r\n                resolve(null);\r\n                return;\r\n            }\r\n\r\n            // Search student applications for this program with fee structure\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"Student Applicant\",\r\n                    filters: { \r\n                        student: studentName,\r\n                        program: program,\r\n                        fee_structure: [\"!=\", \"\"]\r\n                    },\r\n                    fields: [\"fee_structure\"],\r\n                    limit_page_length: 1,\r\n                    order_by: \"creation desc\"\r\n                },\r\n                callback: function (r) {\r\n                    if (r.message && r.message.length > 0 && r.message[0].fee_structure) {\r\n                        resolve(r.message[0].fee_structure);\r\n                    } else {\r\n                        resolve(null);\r\n                    }\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    // ----------------------------\r\n    // HEADER\r\n    // ----------------------------\r\n    const headerCell = document.querySelector(\r\n        '.grid-heading-row [data-fieldname=\"applicant_naming_series\"]'\r\n    );\r\n    if (headerCell) {\r\n        const staticArea = headerCell.querySelector('.static-area');\r\n        if (staticArea) {\r\n            staticArea.textContent = 'Fees | Apply';\r\n        }\r\n    }\r\n\r\n    // ----------------------------\r\n    // ROWS\r\n    // ----------------------------\r\n    const namingCells = document.querySelectorAll(\r\n        '.data-row [data-fieldname=\"applicant_naming_series\"]'\r\n    );\r\n\r\n    namingCells.forEach(cell => {\r\n        // Check if buttons already exist\r\n        if (cell.querySelector('.btn-course-fees')) {\r\n            return; // Skip if buttons already exist\r\n        }\r\n\r\n        // Clear any existing content\r\n        const staticArea = cell.querySelector('.static-area');\r\n        if (staticArea) staticArea.innerHTML = '';\r\n\r\n        // Hide input/field area\r\n        const fieldArea = cell.querySelector('.field-area');\r\n        if (fieldArea) fieldArea.style.display = 'none';\r\n\r\n        // Add buttons container\r\n        const buttonsContainer = document.createElement('div');\r\n        buttonsContainer.style.display = 'flex';\r\n        buttonsContainer.style.gap = '5px';\r\n\r\n        const feesBtn = document.createElement('a');\r\n        feesBtn.href = '#';\r\n        feesBtn.textContent = 'Fees';\r\n        feesBtn.className = 'btn-course-fees';\r\n\r\n        const applyBtn = document.createElement('a');\r\n        applyBtn.href = '#';\r\n        applyBtn.textContent = 'Apply';\r\n        applyBtn.className = 'btn-apply';\r\n\r\n        buttonsContainer.appendChild(feesBtn);\r\n        buttonsContainer.appendChild(applyBtn);\r\n        cell.appendChild(buttonsContainer);\r\n\r\n        // Get program from row\r\n        const row = cell.closest('.data-row');\r\n        const program = row.querySelectorAll('.col')[2].textContent.trim();\r\n        \r\n        let isLoading = false;\r\n\r\n        // ---------- FEES CLICK ----------\r\n        feesBtn.addEventListener('click', async function (event) {\r\n            event.preventDefault();\r\n            \r\n            if (isLoading) return;\r\n            \r\n            const academicYear = frappe.web_form.get_value('academic_year');\r\n            const academicTerm = frappe.web_form.get_value('custom_academic_term');\r\n\r\n            if (!program || !academicYear || !academicTerm) {\r\n                frappe.msgprint(\"Please select Program, Academic Year and Academic Term\");\r\n                return;\r\n            }\r\n\r\n            try {\r\n                isLoading = true;\r\n                feesBtn.textContent = 'Loading...';\r\n                \r\n                // Step 1: Try direct fee structure search\r\n                let feeStructureId = null;\r\n                \r\n                const directResult = await new Promise((resolve) => {\r\n                    frappe.call({\r\n                        method: \"frappe.client.get_list\",\r\n                        args: {\r\n                            doctype: \"Fee Structure\",\r\n                            filters: { program, academic_year: academicYear, academic_term: academicTerm },\r\n                            fields: [\"name\"],\r\n                            limit_page_length: 1\r\n                        },\r\n                        callback: function (r) {\r\n                            if (r.message?.length) {\r\n                                resolve(r.message[0].name);\r\n                            } else {\r\n                                resolve(null);\r\n                            }\r\n                        }\r\n                    });\r\n                });\r\n\r\n                if (directResult) {\r\n                    feeStructureId = directResult;\r\n                } else {\r\n                    // Step 2: Try to get from student applications\r\n                    feeStructureId = await getFeeStructureFromStudentApplications(program);\r\n                }\r\n\r\n                // Redirect if found\r\n                if (feeStructureId) {\r\n                    window.location.href = \"/fee-structure/\" + encodeURIComponent(feeStructureId);\r\n                } else {\r\n                    frappe.msgprint(\"No Fee Structure found\");\r\n                }\r\n                \r\n            } catch (error) {\r\n                console.error(\"Error:\", error);\r\n                frappe.msgprint(\"An error occurred while fetching fee structure\");\r\n            } finally {\r\n                isLoading = false;\r\n                feesBtn.textContent = 'Fees';\r\n            }\r\n        });\r\n\r\n        // ---------- APPLY CLICK ----------\r\n        applyBtn.addEventListener('click', function (event) {\r\n            event.preventDefault();\r\n            if (!program) {\r\n                frappe.msgprint(\"Program not found\");\r\n                return;\r\n            }\r\n             // Store program in localStorage\r\n    localStorage.setItem('selectedProgram', program);\r\n    \r\n    // Optional: Also store with timestamp for expiration\r\n    const programData = {\r\n        value: program,\r\n        timestamp: new Date().getTime()\r\n    };\r\n    localStorage.setItem('programData', JSON.stringify(programData));\r\n    sessionStorage.setItem('selectedProgram', program);\r\n    console.log(\"Program stored in localStorage:\", program);\r\n            window.location.href = \"/student-application-form?program=\" + encodeURIComponent(program);\r\n        });\r\n    });\r\n};",
 "condition_json": "[]",
 "creation": "2025-12-19 12:46:07.205971",
 "custom_css": "/*.web-list-actions .button-new,*/\n/*.grid-footer-toolbar .grid-shortcuts,*/\n/*.grid-header-toolbar .panel-title,*/\n/*.grid-append-row,*/\n/*.grid-form-heading {*/\n/*    display: none;*/\n/*}*/\n",
 "doc_type": "Student Admission",
 "docstatus": 0,
 "doctype": "Web Form",
 "idx": 0,
 "is_standard": 1,
 "list_columns": [],
 "list_title": "OpenAdmissions",
 "login_required": 1,
 "max_attachment_size": 0,
 "modified": "2025-12-23 13:33:16.990555",
 "modified_by": "Administrator",
 "module": "Education",
 "name": "open-admissions",
 "owner": "Administrator",
 "published": 1,
 "route": "open-admissions",
 "show_attachments": 0,
 "show_list": 1,
 "show_sidebar": 1,
 "title": "Open Admissions",
 "web_form_fields": [
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "title",
   "fieldtype": "Data",
   "hidden": 0,
   "label": "Title",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "academic_year",
   "fieldtype": "Link",
   "hidden": 0,
   "label": "Academic Year",
   "max_length": 0,
   "max_value": 0,
   "options": "Academic Year",
   "precision": "",
   "read_only": 0,
   "reqd": 1,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "custom_academic_term",
   "fieldtype": "Link",
   "hidden": 0,
   "label": "Academic Term",
   "max_length": 0,
   "max_value": 0,
   "options": "Academic Term",
   "precision": "",
   "read_only": 0,
   "reqd": 1,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "column_break_3",
   "fieldtype": "Column Break",
   "hidden": 0,
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "admission_start_date",
   "fieldtype": "Date",
   "hidden": 0,
   "label": "Admission Start Date",
   "mandatory_depends_on": "enable_admission_application",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "admission_end_date",
   "fieldtype": "Date",
   "hidden": 0,
   "label": "Admission End Date",
   "mandatory_depends_on": "enable_admission_application",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "section_break_5",
   "fieldtype": "Section Break",
   "hidden": 0,
   "label": "Eligibility and Details",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "program_details",
   "fieldtype": "Table",
   "hidden": 0,
   "label": "",
   "max_length": 0,
   "max_value": 0,
   "options": "Student Admission Program",
   "precision": "",
   "read_only": 1,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "introduction",
   "fieldtype": "Text Editor",
   "hidden": 0,
   "label": "Introduction",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  }
 ],
 "website_sidebar": "Website Side Pannel"
}